<!DOCTYPE html>
<!-- this file is auto-generated from webgl/lessons/ja/webgl-3d-lighting-directional.md. Do not edited directly -->
<!--
Copyright 2012, Gregg Tavares.
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are
met:

*   Redistributions of source code must retain the above copyright
    notice, this list of conditions and the following disclaimer.

*   Redistributions in binary form must reproduce the above
    copyright notice, this list of conditions and the following disclaimer
    in the documentation and/or other materials provided with the
    distribution.

*   Neither the name of Gregg Tavares. nor the names of his
    contributors may be used to endorse or promote products derived from
    this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
"AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
-->
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="WebGLで指向性光源計算し方" />
<meta name="keywords" content="webgl graphics" />
<meta name="thumbnail" content="https://webglfundamentals.org/webgl/lessons/screenshots/webgl-3d-lighting-directional_ja.jpg" />

<meta property="og:title" content="WebGL三次元指向性光源" />
<meta property="og:type" content="website" />
<meta property="og:image" content="https://webglfundamentals.org/webgl/lessons/screenshots/webgl-3d-lighting-directional_ja.jpg" />
<meta property="og:description" content="WebGLで指向性光源計算し方" />
<meta property="og:url" content="https://webglfundamentals.org/webgl/lessons/ja/webgl-3d-lighting-directional.html" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content="@greggman" />
<meta name="twitter:creator" content="@greggman" />
<meta name="twitter:domain" content="webglfundamentals.org" />
<meta name="twitter:title" content="WebGL三次元指向性光源" />
<meta name="twitter:url" content="https://webglfundamentals.org/webgl/lessons/ja/webgl-3d-lighting-directional.html" />
<meta name="twitter:description" content="WebGLで指向性光源計算し方" />
<meta name="twitter:image:src" content="https://webglfundamentals.org/webgl/lessons/screenshots/webgl-3d-lighting-directional_ja.jpg" />

<script type="application/ld+json">
{
  "@context":"https://schema.org",
  "@graph":[
    {
      "@type":"WebSite",
      "@id":"https://webglfundamentals.org/#website",
      "url":"https://webglfundamentals.org/",
      "name":"WebglFundamentals"
    },
    {
      "@type":"ImageObject",
      "@id":"https://webglfundamentals.org/webgl/lessons/ja/webgl-3d-lighting-directional.html#primaryimage",
      "url":"https://webglfundamentals.org/webgl/lessons/screenshots/webgl-3d-lighting-directional_ja.jpg",
      "width":1200,
      "height":630
    },
    {
      "@type":"WebPage",
      "@id":"https://webglfundamentals.org/webgl/lessons/ja/webgl-3d-lighting-directional.html#webpage",
      "url":"https://webglfundamentals.org/webgl/lessons/ja/webgl-3d-lighting-directional.html",
      "inLanguage":"ja",
      "name":"WebGL三次元指向性光源",
      "keywords":"webgl graphics programming",
      "isPartOf":{
        "@id":"https://webglfundamentals.org/#website"
      },
      "primaryImageOfPage":{
        "@id":"https://webglfundamentals.org/webgl/lessons/ja/webgl-3d-lighting-directional.html#primaryimage"
      }
    }
  ]
}
</script>


<title>WebGL三次元指向性光源</title>
<link href="/webgl/lessons/resources/webglfundamentals-icon.png" rel="shortcut icon" type="image/png">
<link rel="stylesheet" href="/webgl/lessons/resources/lesson.css" type="text/css" />



</head>
<body>
<div class="webgl_navbar">
  <div>
    <select class="language">
    <option value="/webgl/lessons/webgl-3d-lighting-directional.html" >English</a>
    <option value="/webgl/lessons/fr/webgl-3d-lighting-directional.html" >Français</a>
    <option value="/webgl/lessons/ja/webgl-3d-lighting-directional.html" selected>日本語</a>
    <option value="/webgl/lessons/ko/webgl-3d-lighting-directional.html" >한국어</a>
    <option value="/webgl/lessons/pl/webgl-3d-lighting-directional.html" >Polski</a>
    <option value="/webgl/lessons/pt-br/webgl-3d-lighting-directional.html" >Portuguese</a>
    <option value="/webgl/lessons/ru/webgl-3d-lighting-directional.html" >Русский</a>
    <option value="/webgl/lessons/zh_cn/webgl-3d-lighting-directional.html" >简体中文</a>
</select>


    <a href="#toc">目次</a>
  </div>
</div>
<div class="webgl_header">
  <h1><a href="/webgl/lessons/ja/">WebGLFundamentals.org</a></h1>
<style>
#forkongithub a {
    background: #000;
    color: #fff;
    text-decoration: none;
    font-family: arial,sans-serif;
    text-align: center;
    font-weight: bold;
    padding: 5px 40px;
    font-size: 0.9rem;
    line-height: 2rem;
    position: relative;
    transition: 0.5s;
    display: block;
    width: 300px;
    position: absolute;
    top: 0;
    right: 0;
    transform: translateX(150px) rotate(45deg) translate(10px,70px);
    box-shadow: 4px 4px 10px rgba(0,0,0,0.8);
    pointer-events: auto;
}
#forkongithub a:hover {
    background: #c11;
    color: #fff;
}
#forkongithub a::before,#forkongithub a::after {
    content: "";
    width: 100%;
    display: block;
    position: absolute;
    top: 1px;
    left: 0;
    height: 1px;
    background: #fff;
}
#forkongithub a::after {
    bottom: 1px;
    top: auto;
}

#forkongithub{
    z-index: 9999;
    /* needed for firefox */
    overflow: hidden;
    width: 300px;
    height: 300px;
    position: absolute;
    right: 0;
    top: 0;
    pointer-events: none;
}
#forkongithub svg{
  width: 1em;
  height: 1em;
  vertical-align: middle;
}
@media (max-width: 900px) {
    #forkongithub a{
        line-height: 1.2rem;
    }
}
@media (max-width: 700px) {
  #forkongithub {
    display: none;
  }
}
@media (max-width: 410px) {
    #forkongithub a{
        font-size: 0.7rem;
        transform: translateX(150px) rotate(45deg) translate(20px,40px);
    }
}

</style>
<div id="forkongithub"><a href="https://github.com/gfxfundamentals/webgl-fundamentals">Fix, Fork, Contribute <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 136 133" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g transform="matrix(3.92891,0,0,3.92891,67.867,129.125)">
        <path d="M0,-31.904C-8.995,-31.904 -16.288,-24.611 -16.288,-15.614C-16.288,-8.417 -11.621,-2.312 -5.148,-0.157C-4.333,-0.008 -4.036,-0.511 -4.036,-0.943C-4.036,-1.329 -4.05,-2.354 -4.058,-3.713C-8.589,-2.729 -9.545,-5.897 -9.545,-5.897C-10.286,-7.779 -11.354,-8.28 -11.354,-8.28C-12.833,-9.29 -11.242,-9.27 -11.242,-9.27C-9.607,-9.155 -8.747,-7.591 -8.747,-7.591C-7.294,-5.102 -4.934,-5.821 -4.006,-6.238C-3.858,-7.29 -3.438,-8.008 -2.972,-8.415C-6.589,-8.826 -10.392,-10.224 -10.392,-16.466C-10.392,-18.244 -9.757,-19.698 -8.715,-20.837C-8.883,-21.249 -9.442,-22.905 -8.556,-25.148C-8.556,-25.148 -7.188,-25.586 -4.076,-23.478C-2.777,-23.84 -1.383,-24.02 0.002,-24.026C1.385,-24.02 2.779,-23.84 4.08,-23.478C7.19,-25.586 8.555,-25.148 8.555,-25.148C9.444,-22.905 8.885,-21.249 8.717,-20.837C9.761,-19.698 10.392,-18.244 10.392,-16.466C10.392,-10.208 6.583,-8.831 2.954,-8.428C3.539,-7.925 4.06,-6.931 4.06,-5.411C4.06,-3.234 4.04,-1.477 4.04,-0.943C4.04,-0.507 4.333,0 5.16,-0.159C11.628,-2.318 16.291,-8.419 16.291,-15.614C16.291,-24.611 8.997,-31.904 0,-31.904" style="fill:white;"/>
    </g>
</svg>
</a></div>

</div>


<div class="container">
  <div class="lesson-title">
    <h1>WebGL三次元指向性光源</h1>
  </div>
  <div class="lesson">
    <div class="lesson-main">
      <p>この記事はWebGLのシリーズの一つである。最初の記事は<a href="webgl-fundamentals.html">WebGLの基本</a>についてだった。
前回の記事は<a href="webgl-3d-camera.html">三次元カメラ</a>についてだった。まだ読んでいなかったら先に読んで下さい。</p>
<p>照明の計算のし方が色々ある。多分一番簡単な方法は指向性光源である。</p>
<p>指向性光源なら光がひとつの方向均一に進んでいく流れていく。
晴れている日の太陽は指向性光源だと考えられている。
太陽は相当遠いから光線が全て平行進んで、あるオブジェクトに当っているようである。</p>
<p>指向性光源の計算は結構簡単である。光線の方向が分かって、オブジェクトの表面の向きも分かっていれば、
その２つの方向の内積(dot product)を計算すると、その２つの方向の間の角度の余弦が出る。</p>
<p>これは例である。</p>
<p><div class="webgl_diagram_container">
  <iframe class="webgl_example " style="width: 400px; height: 300px;" src="/webgl/lessons/resources/dot-product.html"></iframe>
  <div class="webgl_center">頂点を移動してみて</div>
</div>

</p>
<p>頂点を移動して、お互いに真逆の方向にすると内積は-1になる。同じ方向に近づけると内積は1になる。</p>
<p>それがどういうふうに便利なのか？さあ、オブジェクトの表面の方向と光線の方向の両方が分かれば、
その2つの方向の内積を計算すると、照明が表面に向いている場合１になる。反対を向いている場合-１になる。</p>
<p><div class="webgl_diagram_container">
  <iframe class="webgl_example " style="width: 500px; height: 400px;" src="/webgl/lessons/resources/directional-lighting.html?lightDir=%E5%85%89%E7%B7%9A%E6%96%B9%E5%90%91&surface1=%E3%82%AA%E3%83%96%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88&surface2=%E8%A1%A8%E9%9D%A2%E6%96%B9%E5%90%91&dot=dot(%E5%85%89%E7%B7%9A%E5%8F%8D%E5%AF%BE%E6%96%B9%E5%90%91%2C%E8%A1%A8%E9%9D%A2%E6%96%B9%E5%90%91)%20%3D%20&ui-rotation=%E8%A7%92%E5%BA%A6"></iframe>
  <div class="webgl_center">方向を回転してみて</div>
</div>

</p>
<p>表面の色を内積に掛けると照明になる！</p>
<p>まだ一つの問題がある。三次元のオブジェクトの表面方向がどういうふうに分かるか。</p>
<h2 id="-">法線ベクトルの登場</h2>
<p>法線ベクトルは方向を表している。今回三次元のオブジェクトの表面の向きのために使う。</p>
<p>これは四角柱と球体の法線ベクトルである。</p>
<p><div class="webgl_diagram_container">
  <iframe class="webgl_example " style="width: 400px; height: 300px;" src="/webgl/lessons/resources/normals.html"></iframe>
</div>

</p>
<p>オブジェクトから出ている線は頂点ごとの法線ベクトルを表している。</p>
<p>四角柱の場合、角ごとに法線ベクトルが三本あることに注目して下さい。
それはその三つの表面が接しているので、三の法線ベクトルが必要である。</p>
<p>Notice the cube has 3 normals at each corner.  That&#39;s because you need 3
different normals to represent the way each face of the cube is um, ..
facing.</p>
<p>上の図形で法線ベクトルの色は方向を表している。
＋Xは<span style="color: red;">赤</span>, 上は
<span style="color: green;">緑</span>、そして＋Zは
<span style="color: blue;">青</span>。</p>
<p>照明する為に<a href="webgl-3d-camera.html">前回の記事の<code>F</code></a>に法線ベクトルを追加しよう！
<code>F</code>は四角柱と同じように表面がXとYとZ軸と同調しているので結構簡単である。
前を向いている面の法線ベクトルは<code>0, 0, 1</code>である。裏を向いている面の法線ベクトル<code>0, 0, -1</code>である。
左を向いている法線ベクトルは<code>-1, 0, 0</code>である。右は<code>1, 0, 0</code>、上は<code>0, 1, 0</code>、下は<code>0, -1, 0</code>である。</p>
<pre class="prettyprint"><code>function setNormals(gl) {
  var normals = new Float32Array([
          // 前面の左縦列
          0, 0, 1,
          0, 0, 1,
          0, 0, 1,
          0, 0, 1,
          0, 0, 1,
          0, 0, 1,

          // 前面の上の横棒
          0, 0, 1,
          0, 0, 1,
          0, 0, 1,
          0, 0, 1,
          0, 0, 1,
          0, 0, 1,

          // 前面の中の横棒
          0, 0, 1,
          0, 0, 1,
          0, 0, 1,
          0, 0, 1,
          0, 0, 1,
          0, 0, 1,

          // 裏面の左縦列
          0, 0, -1,
          0, 0, -1,
          0, 0, -1,
          0, 0, -1,
          0, 0, -1,
          0, 0, -1,

          // 裏面の上の横棒
          0, 0, -1,
          0, 0, -1,
          0, 0, -1,
          0, 0, -1,
          0, 0, -1,
          0, 0, -1,

          // 裏面の中の横棒
          0, 0, -1,
          0, 0, -1,
          0, 0, -1,
          0, 0, -1,
          0, 0, -1,
          0, 0, -1,

          // 上面
          0, 1, 0,
          0, 1, 0,
          0, 1, 0,
          0, 1, 0,
          0, 1, 0,
          0, 1, 0,

          // 上横棒の上面
          1, 0, 0,
          1, 0, 0,
          1, 0, 0,
          1, 0, 0,
          1, 0, 0,
          1, 0, 0,

          // 上横棒の下面
          0, -1, 0,
          0, -1, 0,
          0, -1, 0,
          0, -1, 0,
          0, -1, 0,
          0, -1, 0,

          // 上横棒と中横棒の間面
          1, 0, 0,
          1, 0, 0,
          1, 0, 0,
          1, 0, 0,
          1, 0, 0,
          1, 0, 0,

          // 中横棒の上面
          0, 1, 0,
          0, 1, 0,
          0, 1, 0,
          0, 1, 0,
          0, 1, 0,
          0, 1, 0,

          // 中横棒の右面
          1, 0, 0,
          1, 0, 0,
          1, 0, 0,
          1, 0, 0,
          1, 0, 0,
          1, 0, 0,

          // 中横棒の下面
          0, -1, 0,
          0, -1, 0,
          0, -1, 0,
          0, -1, 0,
          0, -1, 0,
          0, -1, 0,

          // 下の部分の右面
          1, 0, 0,
          1, 0, 0,
          1, 0, 0,
          1, 0, 0,
          1, 0, 0,
          1, 0, 0,

          // 下面
          0, -1, 0,
          0, -1, 0,
          0, -1, 0,
          0, -1, 0,
          0, -1, 0,
          0, -1, 0,

          // 左面
          -1, 0, 0,
          -1, 0, 0,
          -1, 0, 0,
          -1, 0, 0,
          -1, 0, 0,
          -1, 0, 0,
  ]);
  gl.bufferData(gl.ARRAY_BUFFER, normals, gl.STATIC_DRAW);
}
</code></pre><p>そしてそれをセットアップする。その間照明を分かり易くする為に頂点の色を抜く。</p>
<pre class="prettyprint"><code>// データはどれの属性に与えなければいけないかを調べる。
var positionLocation = gl.getAttribLocation(program, &quot;a_position&quot;);
-var colorLocation = gl.getAttribLocation(program, &quot;a_color&quot;);
+var normalLocation = gl.getAttribLocation(program, &quot;a_normal&quot;);

...

-// 色のバッファーの作成。
-var colorBuffer = gl.createBuffer();
-gl.bindBuffer(gl.ARRAY_BUFFER, colorBuffer);
-// バッファーに色を入れる。
-setColors(gl);

+// 法線ベクトルのバッファーを作成する。
+var normalBuffer = gl.createBuffer();
+gl.bindBuffer(gl.ARRAY_BUFFER, normalBuffer);
+// バッファーに法線ベクトルを入れる。
+setNormals(gl);
</code></pre><p>そして描画する時</p>
<pre class="prettyprint"><code>-// 色の属性オンにする。
-gl.enableVertexAttribArray(colorLocation);
-
-// colorBufferをARRAY_BUFFERに結び付ける。
-gl.bindBuffer(gl.ARRAY_BUFFER, colorBuffer);
-
-// 属性にどうやってcolorBuffer（ARRAY_BUFFER)からデータを取り出すか。
-var size = 3;                  // 呼び出すごとに3つの数値
-var type = gl.UNSIGNED_BYTE;   // データは8ビット符号なし整数
-var normalize = true;          // データをnormalizeする（０〜２５５から０−１に）
-var stride = 0;                // シェーダーを呼び出すごとに進む距離
-                               // 0 = size * sizeof(type)
-var offset = 0;                // バッファーの頭から取り始める
-gl.vertexAttribPointer(
-    colorLocation, size, type, normalize, stride, offset)

+// 法線ベクトルの属性オンにする。
+gl.enableVertexAttribArray(normalLocation);
+
+// normalBufferをARRAY_BUFFERに結び付ける。
+gl.bindBuffer(gl.ARRAY_BUFFER, normalBuffer);
+
+// 属性にどうやってnormalBuffer（ARRAY_BUFFER)からデータを取り出すか。
+var size = 3;                  // 呼び出すごとに3つの数値
+var type = gl.FLOAT;           // データは32ビットの数値
+var normalize = false;         // データをnormalizeしない
+var stride = 0;                // シェーダーを呼び出すごとに進む距離
+                               // 0 = size * sizeof(type)
+var offset = 0;                // バッファーの頭から取り始める
+gl.vertexAttribPointer(
+    normalLocation, size, type, normalize, stride, offset)
</code></pre><p>シェーダーに法線ベクトルを使わせよう</p>
<p>まず、頂点シェーダーで法線ベクトルをピクセルシェーダーに伝えるように更新する。</p>
<pre class="prettyprint"><code>attribute vec4 a_position;
-attribute vec4 a_color;
+attribute vec3 a_normal;

uniform mat4 u_matrix;

-varying vec4 v_color;
+varying vec3 v_normal;

void main() {
  // positionを行列に掛ける。
  gl_Position = u_matrix * a_position;

-  // 色をピクセルシェーダーに渡す。
-  v_color = a_color;

+  // 線ベクトルをピクセルシェーダーに渡す。
+  v_normal = a_normal;
}
</code></pre><p>そして、ピクセルシェーダーで光線の方向と法線ベクトルの内積を計算する。</p>
<pre class="prettyprint"><code>precision mediump float;

// 頂点シェーダーに渡された。
-varying vec4 v_color;
+varying vec3 v_normal;

+uniform vec3 u_reverseLightDirection;
+uniform vec4 u_color;

void main() {
+   // v_normalはバリイングなので頂点の間に補間される。
+   // なので単位ベクトルになっていない。ノーマライズすると
+   // 単位ベクトルに戻す。
+   vec3 normal = normalize(v_normal);
+
+   float light = dot(normal, u_reverseLightDirection);

*   gl_FragColor = u_color;

+   // 色部分だけ照明に掛けよう（アルファ/透明の部分を無視）
+   gl_FragColor.rgb *= light;
}
</code></pre><p><code>u_color</code>と<code>u_reverseLightDirection</code>のユニフォム・ロケーションを調べなきゃ。</p>
<pre class="prettyprint"><code>  // ユニフォムを調べる。
  var matrixLocation = gl.getUniformLocation(program, &quot;u_matrix&quot;);
+  var colorLocation = gl.getUniformLocation(program, &quot;u_color&quot;);
+  var reverseLightDirectionLocation =
+      gl.getUniformLocation(program, &quot;u_reverseLightDirection&quot;);
</code></pre><p>そして、それを設定しなきゃ。</p>
<pre class="prettyprint"><code>  // 行列を設定する。
  gl.uniformMatrix4fv(matrixLocation, false, worldViewProjectionMatrix);

+  // 色を設定する。
+  gl.uniform4fv(colorLocation, [0.2, 1, 0.2, 1]); // green
+
+  // 光線の方向を設定する。
+  gl.uniform3fv(reverseLightDirectionLocation, m4.normalize([0.5, 0.7, 1]));
</code></pre><p>以前に説明した<code>m4.normalize</code>であるベクトルを単位ベクトルに出来る。この場合、
<code>x = 0.5</code>が<code>+x</code>の意味は指向性光源が右から左に向いてることである。
<code>y = 0.7</code>が<code>+y</code>の意味は指向性光源が上から下に向いてることである。
<code>z = 1</code>が<code>+z</code>の意味は指向性光源が前から中を目指していることである。
お互いの相対値の意味は光線がほとんど中を目指していて、さらに左より下への方向性が強いことである。</p>
<p>さあ、これである。</p>
<p><div class="webgl_example_container">
  <iframe class="webgl_example" style=" " src="/webgl/resources/editor.html?url=/webgl/lessons/..%2Fwebgl-3d-lighting-directional.html%3Fui-fRotation%3DF%25E3%2581%25AE%25E5%259B%259E%25E8%25BB%25A2"></iframe>
  <a class="webgl_center" href="/webgl/lessons/../webgl-3d-lighting-directional.html?ui-fRotation=F%E3%81%AE%E5%9B%9E%E8%BB%A2" target="_blank">クリックして別のウインドウを開く</a>
</div>

</p>
<p><code>F</code>を回転してみるとちょっと可怪しいに気付くだろう。「F」が回転しているが、照明が変わらないことである。
「F」を回転しながら照明に向いている部分は一番明るくなって欲しいだろう？</p>
<p>それを直す為にオブジェクト座標を回転させるのと同じように、法線ベクトルも回転させなければいけない。
<code>position</code>と同じように法線をある行列に掛ける必要がある。それはそう考えるとワールド行列を思い起こすだろう。
今は<code>u_matrix</code>という一つの行列しか使われていない。行列を２つにしよう。一つは<code>u_world</code>として、
それがワールド行列になる。もう一つと<code>u_worldViewProjection</code>として、
それが今までの<code>u_matrix</code>と同じような行列になる。</p>
<pre class="prettyprint"><code>attribute vec4 a_position;
attribute vec3 a_normal;

*uniform mat4 u_worldViewProjection;
+uniform mat4 u_world;

varying vec3 v_normal;

void main() {
  // positionを行列に掛ける。
*  gl_Position = u_worldViewProjection * a_position;

*  // 法線ベクトルの向きを計算して、ピクセルシェーダーに渡す。
*  v_normal = mat3(u_world) * a_normal;
}
</code></pre><p><code>a_normal</code>を<code>mat3(u_world)</code>に掛けていることに注目して。
法線ベクトルは方向だけなので行列の移動する部分が要らない。行列の向き部分は上の3x3の部分である。</p>
<p>ユニフォームを調べなきゃ。</p>
<pre class="prettyprint"><code>  // ユニフォームを調べる。
*  var worldViewProjectionLocation =
*      gl.getUniformLocation(program, &quot;u_worldViewProjection&quot;);
+  var worldLocation = gl.getUniformLocation(program, &quot;u_world&quot;);
</code></pre><p>そして、行列を設定しているところの更新が必要である。</p>
<pre class="prettyprint"><code>*// 行列を設定する。
*gl.uniformMatrix4fv(
*    worldViewProjectionLocation, false,
*    worldViewProjectionMatrix);
*gl.uniformMatrix4fv(worldLocation, false, worldMatrix);
</code></pre><p>そして、これ。</p>
<p><div class="webgl_example_container">
  <iframe class="webgl_example" style=" " src="/webgl/resources/editor.html?url=/webgl/lessons/..%2Fwebgl-3d-lighting-directional-world.html%3Fui-fRotation%3DF%25E3%2581%25AE%25E5%259B%259E%25E8%25BB%25A2"></iframe>
  <a class="webgl_center" href="/webgl/lessons/../webgl-3d-lighting-directional-world.html?ui-fRotation=F%E3%81%AE%E5%9B%9E%E8%BB%A2" target="_blank">クリックして別のウインドウを開く</a>
</div>

</p>
<p>「F」を回転してみて、指向性光源に向いている部分が明るくなることに注目して下さい。</p>
<p>まだ問題があるが説明しにくいので図形で見よう。
<code>normal</code>の向きを変更するために<code>u_world</code>の行列に掛けている。
ワールド行列にスケールを掛けるとどうなるか？法線ベクトルはダメになる。</p>
<p><div class="webgl_diagram_container">
  <iframe class="webgl_example " style="width: 600px; height: 300px;" src="/webgl/lessons/resources/normals-scaled.html"></iframe>
  <div class="webgl_center">クリックして表示したかが変わる</div>
</div>

</p>
<p>私も解決方法の理論はまだ学んでないけど、ワールド行列の逆行列を計算して、その行列の転置行列を
使えば、法線ベクトルの方向が正しくなる。転置行列はある行列の横列と縦列を交換した行列である。</p>
<p>上の図形で<span style="color: #F0F;">紫</span>の球体はスケールに掛けられてない。 
左にある<span style="color: #F00;">赤い</span>球体がスケールに掛けられて、法線ベクトルは
ワールド行列に掛けられている。なんとなく何かが間違えていることに気付くだろう？
右にある<span style="color: #00F;">青い</span>球体は転置されたワールドの逆行列に掛けられている。</p>
<p>図形をクリックしたら表示方法が変わる。スケールが大きくなるほど掛けられている時左の方の法線ベクトル(world)は
球体の表面に垂直になっていないことがよく見えるだろう。右の方(worldInverseTranspose)はいつも
球体表面に垂直になっている。最後の表示のしかたで全部赤で描画して、外側の２つの球体は結構違って表示されていることが
見えるはず。どっちが正しいか分かりやすくないかもしれないけど、他の表示のし方でworldInverseTranspose
の方が正しいと分かるはず。</p>
<p>この解決方法を実装するためにこういうふうに変更しよう。まず、シェーダーを更新する。
技術的に<code>u_world</code>の値だけ変更出来るが、正しい意味がある変数の名前を付けた方がいい。
そうしないとコードが分かりにくくなる。</p>
<pre class="prettyprint"><code>attribute vec4 a_position;
attribute vec3 a_normal;

uniform mat4 u_worldViewProjection;
*uniform mat4 u_worldInverseTranspose;

varying vec3 v_normal;

void main() {
  // positionを行列に掛ける。
  gl_Position = u_worldViewProjection * a_position;

  // 法線ベクトルの向きを計算して、ピクセルシェーダーに渡す。
*  v_normal = mat3(u_worldInverseTranspose) * a_normal;
}
</code></pre><p>そして、それを調べなきゃ</p>
<pre class="prettyprint"><code>-  var worldLocation = gl.getUniformLocation(program, &quot;u_world&quot;);
+  var worldInverseTransposeLocation =
+      gl.getUniformLocation(program, &quot;u_worldInverseTranspose&quot;);
</code></pre><p>そして、計算して設定しなきゃ。</p>
<pre class="prettyprint"><code>var worldViewProjectionMatrix = m4.multiply(viewProjectionMatrix, worldMatrix);
var worldInverseMatrix = m4.inverse(worldMatrix);
var worldInverseTransposeMatrix = m4.transpose(worldInverseMatrix);

// 行列を設定する。
gl.uniformMatrix4fv(
    worldViewProjectionLocation, false,
    worldViewProjectionMatrix);
-gl.uniformMatrix4fv(worldLocation, false, worldMatrix);
+gl.uniformMatrix4fv(
+    worldInverseTransposeLocation, false,
+    worldInverseTransposeMatrix);
</code></pre><p>行列を転置するコードはこれである。</p>
<pre class="prettyprint"><code>var m4 = {
  transpose: function(m) {
    return [
      m[0], m[4], m[8], m[12],
      m[1], m[5], m[9], m[13],
      m[2], m[6], m[10], m[14],
      m[3], m[7], m[11], m[15],
    ];
  },

  ...
</code></pre><p>スケールに掛けてないので前のサンプルと同じように表示されているが、
スケールがに掛ける場合に準備が出来た。</p>
<p><div class="webgl_example_container">
  <iframe class="webgl_example" style=" " src="/webgl/resources/editor.html?url=/webgl/lessons/..%2Fwebgl-3d-lighting-directional-worldinversetranspose.html%3Fui-fRotation%3DF%25E3%2581%25AE%25E5%259B%259E%25E8%25BB%25A2"></iframe>
  <a class="webgl_center" href="/webgl/lessons/../webgl-3d-lighting-directional-worldinversetranspose.html?ui-fRotation=F%E3%81%AE%E5%9B%9E%E8%BB%A2" target="_blank">クリックして別のウインドウを開く</a>
</div>

</p>
<p>この照明の計算の第一歩は分かりやすかったかな〜。次回は<a href="webgl-3d-lighting-point.html">点光源である</a>。</p>
<div class="webgl_bottombar">
<h3><code>mat3(u_worldInverseTranspose) * a_normal</code>の代わり</h3>
<p>上のシェーダーにこのような行がある。</p>
<pre class="prettyprint">
v_normal = mat3(u_worldInverseTranspose) * a_normal;
</pre>
<p>このようにしても構わない。</p>
<pre class="prettyprint">
v_normal = (u_worldInverseTranspose * vec4(a_normal, 0)).xyz;
</pre>
<p><code>w</code>を0にすると行列の移動する部分は0に掛けられる。なので移動の部分消されることになる。
どっちの方が一般的か分からない。今回は<code>mat3</code>の方法の方が綺麗なような気がした。下のようにしたこともある。
</p>
<p>もう一つの方法として<code>u_worldInverseTranspose</code>を<code>mat3</code>にすることもあるが、
そのようにしない方がいい理由が2つある。一つ目は<code>mat4</code>で<code>u_worldInverseTranspose</code>を
使う場合もあるので<code>mat4</code>として渡せばmat4で必要な場合にも使える。
二つ目は今まで使っている行列数学ライブラリは
<code>mat4</code>しか作れない。<code>mat3</code>のライブラリを作るのは面倒で、
mat4からmat3に変更することもコンピューターにさせたくないので、
特別の理由がなければ<code>mat4</code>でいいと思う。</p>
</div>

    </div>
    <div class="lesson-sidebar">
        <select class="language">
    <option value="/webgl/lessons/webgl-3d-lighting-directional.html" >English</a>
    <option value="/webgl/lessons/fr/webgl-3d-lighting-directional.html" >Français</a>
    <option value="/webgl/lessons/ja/webgl-3d-lighting-directional.html" selected>日本語</a>
    <option value="/webgl/lessons/ko/webgl-3d-lighting-directional.html" >한국어</a>
    <option value="/webgl/lessons/pl/webgl-3d-lighting-directional.html" >Polski</a>
    <option value="/webgl/lessons/pt-br/webgl-3d-lighting-directional.html" >Portuguese</a>
    <option value="/webgl/lessons/ru/webgl-3d-lighting-directional.html" >Русский</a>
    <option value="/webgl/lessons/zh_cn/webgl-3d-lighting-directional.html" >简体中文</a>
</select>


        <div id="toc">
          <ul>  <li>基本</li>
        <ul>
          <li><a href="/webgl/lessons/ja/webgl-fundamentals.html">基本</a></li>
<li><a href="/webgl/lessons/ja/webgl-how-it-works.html">WebGLの仕組み</a></li>
<li><a href="/webgl/lessons/ja/webgl-shaders-and-glsl.html">WebGLのシェーダーとGLSL</a></li>
<li><a href="/webgl/lessons/resources/webgl-state-diagram.html">WebGL State Diagram</a></li>
        </ul>
  <li>画像処理</li>
        <ul>
          <li><a href="/webgl/lessons/ja/webgl-image-processing.html">WebGLにおける画像処理</a></li>
<li><a href="/webgl/lessons/ja/webgl-image-processing-continued.html">WebGLにおける画像処理。続き</a></li>
        </ul>
  <li>2Dでの移動、回転、拡大縮小、行列計算</li>
        <ul>
          <li><a href="/webgl/lessons/ja/webgl-2d-translation.html">二次元での移動</a></li>
<li><a href="/webgl/lessons/ja/webgl-2d-rotation.html">二次元での回転</a></li>
<li><a href="/webgl/lessons/ja/webgl-2d-scale.html">二次元での拡大縮小</a></li>
<li><a href="/webgl/lessons/ja/webgl-2d-matrices.html">二次元での行列数学</a></li>
        </ul>
  <li>3D</li>
        <ul>
          <li><a href="/webgl/lessons/ja/webgl-3d-orthographic.html">三次元の正投影</a></li>
<li><a href="/webgl/lessons/ja/webgl-3d-perspective.html">三次元透視投影</a></li>
<li><a href="/webgl/lessons/ja/webgl-3d-camera.html">三次元のカメラ</a></li>
        </ul>
  <li>Lighting</li>
        <ul>
          <li><a href="/webgl/lessons/ja/webgl-3d-lighting-directional.html">三次元指向性光源</a></li>
<li><a href="/webgl/lessons/ja/webgl-3d-lighting-point.html">三次元点光源</a></li>
<li><a href="/webgl/lessons/ja/webgl-3d-lighting-spot.html">Spot Lighting</a></li>
        </ul>
  <li>Structure and Organization</li>
        <ul>
          <li><a href="/webgl/lessons/ja/webgl-less-code-more-fun.html">Less Code, More Fun</a></li>
<li><a href="/webgl/lessons/ja/webgl-drawing-multiple-things.html">Drawing Multiple Things</a></li>
<li><a href="/webgl/lessons/ja/webgl-scene-graph.html">Scene Graphs</a></li>
        </ul>
  <li>Geometry</li>
        <ul>
          <li><a href="/webgl/lessons/ja/webgl-3d-geometry-lathe.html">Geometry - Lathe</a></li>
<li><a href="/webgl/lessons/ja/webgl-load-obj.html">Loading .obj files</a></li>
<li><a href="/webgl/lessons/ja/webgl-load-obj-w-mtl.html">Loading .obj w .mtl files</a></li>
        </ul>
  <li>テクスチャ</li>
        <ul>
          <li><a href="/webgl/lessons/ja/webgl-3d-textures.html">Textures</a></li>
<li><a href="/webgl/lessons/ja/webgl-data-textures.html">データテクスチャ</a></li>
<li><a href="/webgl/lessons/ja/webgl-2-textures.html">複数のテクスチャを使う</a></li>
<li><a href="/webgl/lessons/ja/webgl-cors-permission.html">Cross Origin Images</a></li>
<li><a href="/webgl/lessons/ja/webgl-3d-perspective-correct-texturemapping.html">Perspective Correct Texture Mapping</a></li>
<li><a href="/webgl/lessons/ja/webgl-planar-projection-mapping.html">Planar and Perspective Projection Mapping</a></li>
        </ul>
  <li>Rendering To A Texture</li>
        <ul>
          <li><a href="/webgl/lessons/ja/webgl-render-to-texture.html">Render to Texture</a></li>
        </ul>
  <li>Shadows</li>
        <ul>
          <li><a href="/webgl/lessons/ja/webgl-shadows.html">Shadows</a></li>
        </ul>
  <li>Techniques</li>
        <ul>
            <li>2D</li>
        <ul>
          <li><a href="/webgl/lessons/ja/webgl-2d-drawimage.html">2D - DrawImage</a></li>
<li><a href="/webgl/lessons/ja/webgl-2d-matrix-stack.html">2D - Matrix Stack</a></li>
<li><a href="/webgl/lessons/ja/webgl-sprites.html">Sprites</a></li>
        </ul>
  <li>3D</li>
        <ul>
          <li><a href="/webgl/lessons/ja/webgl-cube-maps.html">Cubemaps</a></li>
<li><a href="/webgl/lessons/ja/webgl-environment-maps.html">Environment maps</a></li>
<li><a href="/webgl/lessons/ja/webgl-skybox.html">Skyboxes</a></li>
<li><a href="/webgl/lessons/ja/webgl-skinning.html">Skinning</a></li>
<li><a href="/webgl/lessons/ja/webgl-fog.html">Fog</a></li>
<li><a href="/webgl/lessons/ja/webgl-picking.html">Picking (clicking on stuff)</a></li>
        </ul>
  <li>Text</li>
        <ul>
          <li><a href="/webgl/lessons/ja/webgl-text-html.html">Text - HTML</a></li>
<li><a href="/webgl/lessons/ja/webgl-text-canvas2d.html">Text - Canvas 2D</a></li>
<li><a href="/webgl/lessons/ja/webgl-text-texture.html">Text - Using a Texture</a></li>
<li><a href="/webgl/lessons/ja/webgl-text-glyphs.html">Text - Using a Glyph Texture</a></li>
        </ul>
  <li>テクスチャ</li>
        <ul>
          <li><a href="/webgl/lessons/ja/webgl-ramp-textures.html">Ramp Textures (Toon Shading)</a></li>
        </ul>
        </ul>
  <li>Tips</li>
        <ul>
          <li><a href="/webgl/lessons/ja/webgl-smallest-programs.html">Smallest Programs</a></li>
<li><a href="/webgl/lessons/ja/webgl-drawing-without-data.html">Drawing Without Data</a></li>
<li><a href="/webgl/lessons/ja/webgl-shadertoy.html">Shadertoy</a></li>
<li><a href="/webgl/lessons/ja/webgl-pulling-vertices.html">Pulling Vertices</a></li>
        </ul>
  <li>その他のトピック</li>
        <ul>
          <li><a href="/webgl/lessons/ja/webgl-setup-and-installation.html">WebGLの開発環境</a></li>
<li><a href="/webgl/lessons/ja/webgl-boilerplate.html">WebGLのひな型コード</a></li>
<li><a href="/webgl/lessons/ja/webgl-resizing-the-canvas.html">WebGLとcanvasのリサイズ</a></li>
<li><a href="/webgl/lessons/ja/webgl-animation.html">アニメーション</a></li>
<li><a href="/webgl/lessons/ja/webgl-points-lines-triangles.html">Points, Lines, and Triangles</a></li>
<li><a href="/webgl/lessons/ja/webgl-indexed-vertices.html">Indexed Vertices (gl.drawElements)</a></li>
<li><a href="/webgl/lessons/ja/webgl-instanced-drawing.html">Instanced Drawing</a></li>
<li><a href="/webgl/lessons/ja/webgl-multiple-views.html">Multiple Views, Multiple Canvases</a></li>
<li><a href="/webgl/lessons/ja/webgl-visualizing-the-camera.html">Visualizing the Camera</a></li>
<li><a href="/webgl/lessons/ja/webgl-and-alpha.html">WebGL and Alpha</a></li>
<li><a href="/webgl/lessons/ja/webgl-2d-vs-3d-library.html">2D vs 3D libraries</a></li>
<li><a href="/webgl/lessons/ja/webgl-anti-patterns.html">Anti-Patterns</a></li>
<li><a href="/webgl/lessons/ja/webgl-matrix-vs-math.html">WebGL Matrices vs Math Matrices</a></li>
<li><a href="/webgl/lessons/ja/webgl-precision-issues.html">Precision Issues</a></li>
<li><a href="/webgl/lessons/ja/webgl-tips.html#screenshot">Taking a screenshot</a></li>
<li><a href="/webgl/lessons/ja/webgl-tips.html#preservedrawingbuffer">Prevent the Canvas Being Cleared</a></li>
<li><a href="/webgl/lessons/ja/webgl-tips.html#tabindex">Get Keyboard Input From a Canvas</a></li>
<li><a href="/webgl/lessons/ja/webgl-tips.html#html-background">Use WebGL as Background in HTML</a></li>
        </ul>
  <li>Reference</li>
        <ul>
          <li><a href="/webgl/lessons/ja/webgl-attributes.html">Attributes</a></li>
<li><a href="/webgl/lessons/ja/webgl-texture-units.html">Texture Units</a></li>
<li><a href="/webgl/lessons/ja/webgl-readpixels.html">readPixels</a></li>
<li><a href="/webgl/lessons/ja/webgl-references.html">References</a></li>
        </ul></ul>
<ul>
  <li><a href="/docs/">Helper API Docs(英語)</a></li>
  <li><a href="https://twgljs.org">TWGL, A tiny WebGL helper library</a></li>
  <li><a href="https://github.com/gfxfundamentals/webgl-fundamentals">github</a></li>
</ul>
        </div>
    </div>
    <div class="lesson-comments">
        <div>質問? <a href="https://stackoverflow.com/questions/tagged/webgl">stackoverflowで質問(英語)</a>.</div>
        <div>問題点/バグ? <a href="https://github.com/gfxfundamentals/webgl-fundamentals/issues">githubでissueを作成</a>.</div>

        <div id="disqus_thread"></div>
        <script>
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'webglfundamentals'; // required: replace example with your forum shortname
            var disqus_identifier = 'WebGL三次元指向性光源';
            var disqus_title = 'WebGL三次元指向性光源';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                if (window.location.hostname.indexOf("webglfundamentals.org") < 0) {
                    return;
                }
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
  </div>
</div>
</body>
<script src="/3rdparty/jquery-1.11.2.min.js"></script>
<script src="/webgl/lessons/resources/prettify.js"></script>
<script src="/webgl/lessons/resources/lesson.js"></script>
<script>
(function() {
  if (window.location.hostname.indexOf("webglfundamentals.org") < 0) {
      return;
  }

  function addScript(src, fn) {
    const script = document.createElement('script');
    const firstScript = document.getElementsByTagName('script')[0];
    script.async = true;
    script.defer = true;
    if (fn) {
      script.addEventListener('load', fn);
    }
    script.src = src;
    firstScript.parentNode.insertBefore(script, firstScript);
  }

  addScript('//cdn.webglstats.com/stat.js');

  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59804936-1', 'auto');
  ga('send', 'pageview');
}());
</script>


</html>



