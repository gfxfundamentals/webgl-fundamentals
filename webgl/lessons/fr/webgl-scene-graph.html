<!DOCTYPE html>
<!-- this file is auto-generated from webgl/lessons/fr/webgl-scene-graph.md. Do not edited directly -->
<!--
Copyright 2012, Gregg Tavares.
All rights reserved.

Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions are
met:

*   Redistributions of source code must retain the above copyright
    notice, this list of conditions and the following disclaimer.

*   Redistributions in binary form must reproduce the above
    copyright notice, this list of conditions and the following disclaimer
    in the documentation and/or other materials provided with the
    distribution.

*   Neither the name of Gregg Tavares. nor the names of his
    contributors may be used to endorse or promote products derived from
    this software without specific prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
"AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
-->
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Ce qu&#x27;est un graphe de scène et à quoi ça sert" />
<meta name="keywords" content="webgl graphics" />
<meta name="thumbnail" content="https://webglfundamentals.org/webgl/lessons/screenshots/webgl-scene-graph_fr.jpg" />

<meta property="og:title" content="WebGL - Les Graphes de Scène" />
<meta property="og:type" content="website" />
<meta property="og:image" content="https://webglfundamentals.org/webgl/lessons/screenshots/webgl-scene-graph_fr.jpg" />
<meta property="og:description" content="Ce qu&#x27;est un graphe de scène et à quoi ça sert" />
<meta property="og:url" content="https://webglfundamentals.org/webgl/lessons/fr/webgl-scene-graph.html" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:site" content="@greggman" />
<meta name="twitter:creator" content="@greggman" />
<meta name="twitter:domain" content="webglfundamentals.org" />
<meta name="twitter:title" content="WebGL - Les Graphes de Scène" />
<meta name="twitter:url" content="https://webglfundamentals.org/webgl/lessons/fr/webgl-scene-graph.html" />
<meta name="twitter:description" content="Ce qu&#x27;est un graphe de scène et à quoi ça sert" />
<meta name="twitter:image:src" content="https://webglfundamentals.org/webgl/lessons/screenshots/webgl-scene-graph_fr.jpg" />

<script type="application/ld+json">
{
  "@context":"https://schema.org",
  "@graph":[
    {
      "@type":"WebSite",
      "@id":"https://webglfundamentals.org/#website",
      "url":"https://webglfundamentals.org/",
      "name":"WebglFundamentals"
    },
    {
      "@type":"ImageObject",
      "@id":"https://webglfundamentals.org/webgl/lessons/fr/webgl-scene-graph.html#primaryimage",
      "url":"https://webglfundamentals.org/webgl/lessons/screenshots/webgl-scene-graph_fr.jpg",
      "width":1200,
      "height":630
    },
    {
      "@type":"WebPage",
      "@id":"https://webglfundamentals.org/webgl/lessons/fr/webgl-scene-graph.html#webpage",
      "url":"https://webglfundamentals.org/webgl/lessons/fr/webgl-scene-graph.html",
      "inLanguage":"fr",
      "name":"WebGL - Les Graphes de Scène",
      "keywords":"webgl graphics programming",
      "isPartOf":{
        "@id":"https://webglfundamentals.org/#website"
      },
      "primaryImageOfPage":{
        "@id":"https://webglfundamentals.org/webgl/lessons/fr/webgl-scene-graph.html#primaryimage"
      }
    }
  ]
}
</script>


<title>WebGL - Les Graphes de Scène</title>
<link href="/webgl/lessons/resources/webglfundamentals-icon.png" rel="shortcut icon" type="image/png">
<link rel="stylesheet" href="/webgl/lessons/resources/lesson.css" type="text/css" />



</head>
<body>
<div class="webgl_navbar">
  <div>
    <select class="language">
    <option value="/webgl/lessons/webgl-scene-graph.html" >English</a>
    <option value="/webgl/lessons/fr/webgl-scene-graph.html" selected>Français</a>
    <option value="/webgl/lessons/ja/webgl-scene-graph.html" >日本語</a>
    <option value="/webgl/lessons/ko/webgl-scene-graph.html" >한국어</a>
    <option value="/webgl/lessons/pl/webgl-scene-graph.html" >Polski</a>
    <option value="/webgl/lessons/pt-br/webgl-scene-graph.html" >Portuguese</a>
    <option value="/webgl/lessons/ru/webgl-scene-graph.html" >Русский</a>
    <option value="/webgl/lessons/zh_cn/webgl-scene-graph.html" >简体中文</a>
</select>


    <a href="#toc">Table des Matières</a>
  </div>
</div>
<div class="webgl_header">
  <h1><a href="/webgl/lessons/fr/">WebGLFundamentals.org</a></h1>
<style>
#forkongithub a {
    background: #000;
    color: #fff;
    text-decoration: none;
    font-family: arial,sans-serif;
    text-align: center;
    font-weight: bold;
    padding: 5px 40px;
    font-size: 0.9rem;
    line-height: 2rem;
    position: relative;
    transition: 0.5s;
    display: block;
    width: 300px;
    position: absolute;
    top: 0;
    right: 0;
    transform: translateX(150px) rotate(45deg) translate(10px,70px);
    box-shadow: 4px 4px 10px rgba(0,0,0,0.8);
    pointer-events: auto;
}
#forkongithub a:hover {
    background: #c11;
    color: #fff;
}
#forkongithub a::before,#forkongithub a::after {
    content: "";
    width: 100%;
    display: block;
    position: absolute;
    top: 1px;
    left: 0;
    height: 1px;
    background: #fff;
}
#forkongithub a::after {
    bottom: 1px;
    top: auto;
}

#forkongithub{
    z-index: 9999;
    /* needed for firefox */
    overflow: hidden;
    width: 300px;
    height: 300px;
    position: absolute;
    right: 0;
    top: 0;
    pointer-events: none;
}
#forkongithub svg{
  width: 1em;
  height: 1em;
  vertical-align: middle;
}
@media (max-width: 900px) {
    #forkongithub a{
        line-height: 1.2rem;
    }
}
@media (max-width: 700px) {
  #forkongithub {
    display: none;
  }
}
@media (max-width: 410px) {
    #forkongithub a{
        font-size: 0.7rem;
        transform: translateX(150px) rotate(45deg) translate(20px,40px);
    }
}

</style>
<div id="forkongithub"><a href="https://github.com/gfxfundamentals/webgl-fundamentals">Fix, Fork, Contribute <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<svg width="100%" height="100%" viewBox="0 0 136 133" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xml:space="preserve" xmlns:serif="http://www.serif.com/" style="fill-rule:evenodd;clip-rule:evenodd;stroke-linejoin:round;stroke-miterlimit:2;">
    <g transform="matrix(3.92891,0,0,3.92891,67.867,129.125)">
        <path d="M0,-31.904C-8.995,-31.904 -16.288,-24.611 -16.288,-15.614C-16.288,-8.417 -11.621,-2.312 -5.148,-0.157C-4.333,-0.008 -4.036,-0.511 -4.036,-0.943C-4.036,-1.329 -4.05,-2.354 -4.058,-3.713C-8.589,-2.729 -9.545,-5.897 -9.545,-5.897C-10.286,-7.779 -11.354,-8.28 -11.354,-8.28C-12.833,-9.29 -11.242,-9.27 -11.242,-9.27C-9.607,-9.155 -8.747,-7.591 -8.747,-7.591C-7.294,-5.102 -4.934,-5.821 -4.006,-6.238C-3.858,-7.29 -3.438,-8.008 -2.972,-8.415C-6.589,-8.826 -10.392,-10.224 -10.392,-16.466C-10.392,-18.244 -9.757,-19.698 -8.715,-20.837C-8.883,-21.249 -9.442,-22.905 -8.556,-25.148C-8.556,-25.148 -7.188,-25.586 -4.076,-23.478C-2.777,-23.84 -1.383,-24.02 0.002,-24.026C1.385,-24.02 2.779,-23.84 4.08,-23.478C7.19,-25.586 8.555,-25.148 8.555,-25.148C9.444,-22.905 8.885,-21.249 8.717,-20.837C9.761,-19.698 10.392,-18.244 10.392,-16.466C10.392,-10.208 6.583,-8.831 2.954,-8.428C3.539,-7.925 4.06,-6.931 4.06,-5.411C4.06,-3.234 4.04,-1.477 4.04,-0.943C4.04,-0.507 4.333,0 5.16,-0.159C11.628,-2.318 16.291,-8.419 16.291,-15.614C16.291,-24.611 8.997,-31.904 0,-31.904" style="fill:white;"/>
    </g>
</svg>
</a></div>

</div>


<div class="container">
  <div class="lesson-title">
    <h1>WebGL - Les Graphes de Scène</h1>
  </div>
  <div class="lesson">
    <div class="lesson-main">
      <p>Cet article est la suite d&#39;une <a href="webgl-fundamentals.html">série de posts</a> consacrés à WebGL. L&#39;article précédent parlait de <a href="webgl-drawing-multiple-things.html">dessiner plusieurs objets</a>. Si vous ne les avez pas lus vous préférez peut-être y jeter un oeil d&#39;abord.</p>
<p>Je suis sûr qu&#39;un expert en thoérie des graphes va me tirer les oreilles mais... un graphe de scène est un arbre où chaque noeud génère une matrice. Hmmm ce n&#39;est pas une définition très utile. Peut-être qu&#39;avec quelques exemples ce serait mieux.</p>
<p>La plupart des moteurs 3D utilisent des graphes de scènes. On y met les objets qu&#39;on veut voir apparaître dans la scène. Ces moteurs 3D analysent le graphe et déduisent la liste des choses à dessiner. Les graphes de scènes sont hiérarchisés donc par exemple si vous voulez faire une simulation de l&#39;univers vous aurez peut-être un graphe qui ressemble à ça :</p>
<p><div class="webgl_diagram_container">
  <iframe class="webgl_example " style="width: 400px; height: 500px;" src="/webgl/lessons/resources/planet-diagram.html"></iframe>
</div>

</p>
<p>À quoi sert un graphe de scène ? La première fonction d&#39;un graphe de scène est de fournir des relations parents-enfants aux matrices <a href="webgl-2d-matrices.html">présentées ici</a>. Donc pour une simulation simplifiée et non réaliste de l&#39;univers, les étoiles (enfants) se déplacent autour de la galaxie (parent). De même une lune (enfant) se déplace autour d&#39;une planète (parent). Si on déplace la Terre, la Lune va bouger avec elle. Si on déplace une galaxie ses étoiles vont bouger avec. Déplacez les noms dans le diagramme ci-dessus pour voir leur liens de parenté.</p>
<p>Si on se rappelle des <a href="webgl-2d-matrices.html">matrices 2D</a> vous vous souvenez qu&#39;on multiplie plusieurs matrices pour déplacer, tourner et changer l&#39;échelle des géométries. Un graphe de scène fournit une structure pour aider à décider quelle matrice appliquer à un objet. </p>
<p>Chaque <code>Noeud</code> dans un graphe de scène représente un <em>espace de coordonnées local</em>. Avec une matrice qui lui est propre dans ce système de coordonnées, l&#39;objet peut ignorer sa position par rapport à ce qui l&#39;entoure. Une autre façon de dire ça est de s&#39;imaginer que la Lune s&#39;occupe surtout de tourner autour de la Terre. Elle n&#39;a pas vraiment besoin de savoir quelle position elle a par rapport au Soleil. Sans le graphe de scène on aurait à écrire des algorithmes ultra compliqués pour trouver l&#39;orbite de la Lune dans le système de coordonnées du Soleil. Parce qu&#39;elle orbite un peu comme ça :</p>
<p><div class="webgl_diagram_container">
  <iframe class="webgl_example " style="width: 400px; height: 300px;" src="/webgl/lessons/resources/moon-orbit.html"></iframe>
</div>

</p>
<p>Avec un graphe de scène on place juste la Lune comme enfant de la Terre et on la fait tourner autour, ce qui est beaucoup plus simple. Le graphe de scène s&#39;occupe de la position finale en parcourant les noeuds et en multipliant les matrices au fur et à mesure :</p>
<pre class="prettyprint"><code>matriceGlobale = grandGrandParent * grandParent * parent * matriceLocale
</code></pre><p>Concrètement notre simulation de l&#39;univers serait </p>
<pre class="prettyprint"><code>transformationsGlobaleDeLaLune = matriceGalaxie * matriceSoleil * matriceTerre * matriceLocaleLune;
</code></pre><p>On peut faire ça avec une fonction très simple :</p>
<pre class="prettyprint"><code>function creerMatriceGlobale(noeud, matriceGlobaleParent) {
    // calcule notre matrice globale en multipliant la matrice locale avec 
    // la matrice globale du noeud parent
    var matriceGlobale = multiplierMatrices(noeud.matriceLocale, matriceGlobaleParent);

    // pareil pour les enfants
    noeud.enfant.forEach(function(enfant) {
        creerMatriceGlobale(enfant, matriceGlobale);
    });
}
</code></pre><p>Ce qui nous amène à définir quelques notions propres aux graphes de scènes 3D :</p>
<ul>
<li><p><code>matriceLocale</code>: La matrice locale du noeud. Elle transforme les objets du noeud et leurs enfants dans un système de coordonnées où leurs origines devient la même que la sienne.</p>
</li>
<li><p><code>matriceGlobale</code>: Pour un noeud donné elle transforme les sytèmes de coordonnées locaux dans le système de coordonnées du noeud racine. En d&#39;autres termes une matrice globale donne leur position globale. Si on calcule la matrice globale pour la Lune elle nous donne la drôle d&#39;orbite qu&#39;on a vu plus tôt.</p>
</li>
</ul>
<p>Un graphe de scène est assez facile à faire. Définissons un objet <code>Noeud</code>. Il y a des tas de façons d&#39;organiser un graphe de scène et j&#39;ignore quelle est la meilleure. Une façon courrante est d&#39;avoir un champ optionnel avec les objets à dessiner :</p>
<pre class="prettyprint"><code>var noeud = {
   matriceLocale: ...,    // la matrice local du noeud
   matriceGlobale: ...,   // la matrice monde du noeud
   enfants: [],           // tableau d&#39;enfants
   objetsADessiner: ??,   // objets à dessiner dans ce noeud
};
</code></pre><p>Faisons un graphe pour le système solaire. Je ne vais pas utiliser de super textures qui ne sont pas importantes dans cet exemple. D&#39;abord écrivons quelques fonctions pour gérer les noeuds. D&#39;abord la classe Noeud :</p>
<pre class="prettyprint"><code>var Noeud = function() {
  this.enfant = [];
  this.matriceLocale = matriceIdentite(); 
  this.matriceGlobale = matriceIdentite();
};
</code></pre><p>Donnons lui une méthode pour établie des liens de parenté :</p>
<pre class="prettyprint"><code>Noeud.prototype.definirParent = function(parent) {
  // retirer du noeud parent précédent s&#39;il y en avait un
  if (this.parent) {
    var ndx = this.parent.enfant.indexOf(this);
    if (ndx &gt;= 0) {
      this.parent.enfant.splice(ndx, 1);
    }
  }

  // Ajoute au nouveau parent
  if (parent) {
    parent.children.append(this);
  }
  this.parent = parent;
};
</code></pre><p>Et voici le code pour calculer les matrices globales depuis les matrices locales, depuis leurs relations parent-enfant. Si on démarre à la racine et qu&#39;on parcoure les noeuds dans la hiérarchie on peut calculer leurs matrices globales. Si vous vous demandez comment fonctionnent les matrices <a href="webgl-2d-matrices.html">vous pouvez lire l&#39;article sur les matrices 2D</a>.</p>
<pre class="prettyprint"><code>Noeud.prototype.mettreAJourMatriceGlobale = function(matriceGlobaleParent) {
  if (matriceGlobaleParent) {
    // une matrice parent reçue en argument donc 
    // calcule et stocke le résultat dans `this.matriceGlobale`.
    multiplierMatrices(this.matriceLocale, matriceGlobaleParent, this.matriceGlobale);
  } else {
    // pas de matrice reçue en argument
    copierMatrice(this.matriceLocale, this.matriceGlobale);
  }

  // pareil pour tous les enfants
  var matriceGlobale = this.matriceGlobale;
  this.children.forEach(function(enfant) {
    enfant.mettreAJourMatriceGlobale(matriceGlobale);
  });
};
</code></pre><p>Faisons le Soleil, la Terre et la Lune pour avoir une exemple simple. On va utiliser des distances arbitraires pour pouvoir voir quelque chose sur l&#39;écran. On va se contenter d&#39;une sphère jaune pour le Soleil, bleue-verte pour la Terre et grise pour la Lune. Si les termes <code>infoRendu</code>, <code>infoTampon</code> et <code>infoProgramme</code> ne vous sont pas familiers voyez <a href="webgl-drawing-multiple-things.html">l&#39;article précédent</a>.</p>
<pre class="prettyprint"><code>// Ecrivons les noeuds
var noeudSoleil = new Noeud();
noeudSoleil.matriceLocale = deplacer(0, 0, 0);  // Soleil au centre
noeudSoleil.infoRendu = {
  uniforms: {
    u_decalageCouleur: [0.6, 0.6, 0, 1], // jaune
    u_coeffCouleur:   [0.4, 0.4, 0, 1],
  },
  infoProgramme: infoProgramme,
  infoTampon: infoTamponSphere,
};

var noeudTerre = new Noeud();
noeudTerre.matriceLocale = deplacer(100, 0, 0);  // Terre à 100 unités du Soleil
noeudTerre.infoRendu = {
  uniforms: {
    u_decalageCouleur: [0.2, 0.5, 0.8, 1],  // bleu-vert
    u_coeffCouleur:   [0.8, 0.5, 0.2, 1],
  },
  infoProgramme: infoProgramme,
  infoTampon: infoTamponSphere,
};

var noeudLune = new Noeud();
noeudLune.matriceLocale = deplacer(20, 0, 0);  // Lune à 20 unités de la Terre
noeudLune.infoRendu = {
  uniforms: {
    u_decalageCouleur: [0.6, 0.6, 0.6, 1],  // gris
    u_coeffCouleur:   [0.1, 0.1, 0.1, 1],
  },
  infoProgramme: infoProgramme,
  infoTampon: infoTamponSphere,
};
</code></pre><p>Maintenant que c&#39;est fait connectons les noeuds</p>
<pre class="prettyprint"><code>// filiation entre les objets
noeudLune.definirParent(noeudTerre);
noeudTerre.definirParent(noeudSoleil);
</code></pre><p>Ensuite on liste les objets puis les objets à dessiner</p>
<pre class="prettyprint"><code>var objets = [
  noeudSoleil,
  noeudTerre,
  noeudLune,
];

var objetsADessiner = [
  noeudSoleil.infoRendu,
  noeudTerre.infoRendu,
  noeudLune.infoRendu,
];
</code></pre><p>Au moment du rendu on met à jour la matrice locale de chaque objet en la tournant un peu</p>
<pre class="prettyprint"><code>// nouvelle matrice locale pour chaque objet
multiplierMatrices(noeudSoleil.matriceLocale, tournerY(0.01), noeudSoleil.matriceLocale);
multiplierMatrices(noeudTerre.matriceLocale, tournerY(0.01), noeudTerre.matriceLocale);
multiplierMatrices(noeudLune.matriceLocale, tournerY(0.01), noeudLune.matriceLocale);
</code></pre><p>Maintenant que les matrices locales sont à jour on va s&#39;occuper des matrices globales.</p>
<pre class="prettyprint"><code>noeudSoleil.mettreAJourMatriceGlobale();
</code></pre><p>Maintenant qu&#39;on a nos matrices globales on doit les multiplier pour avoir une <a href="webgl-3d-perspective.html">matriceGlobaleVue</a> pour chaque objet.</p>
<pre class="prettyprint"><code>// Calcule toutes les matrices pour le rendu
objects.forEach(function(objet) {
  objet.infoRendu.uniforms.u_matrice = multiplierMatrices(objet.matriceGlobale, matriceGlobaleVue);
});
</code></pre><p>Le rendu est <a href="webgl-drawing-multiple-things.html">la boucle évoquée dans l&#39;article précedent</a>.</p>
<p><div class="webgl_example_container">
  <iframe class="webgl_example" style=" " src="/webgl/resources/editor.html?url=/webgl/lessons/..%2Fwebgl-scene-graph-solar-system.html"></iframe>
  <a class="webgl_center" href="/webgl/lessons/../webgl-scene-graph-solar-system.html" target="_blank">Cliquer ici pour ouvrir dans une nouvelle fenêtre</a>
</div>

</p>
<p>Toutes les objets sont de la même taille. Essayons de rendre la Terre plus grande</p>
<pre class="prettyprint"><code>noeudTerre.matriceLocale = multiplierMatrices(
    changerEchelle(2, 2, 2),           // Terre plus grosse
    deplacer(100, 0, 0));              // Terre à 100 unités du soleil
</code></pre><p><div class="webgl_example_container">
  <iframe class="webgl_example" style=" " src="/webgl/resources/editor.html?url=/webgl/lessons/..%2Fwebgl-scene-graph-solar-system-larger-earth.html"></iframe>
  <a class="webgl_center" href="/webgl/lessons/../webgl-scene-graph-solar-system-larger-earth.html" target="_blank">Cliquer ici pour ouvrir dans une nouvelle fenêtre</a>
</div>

</p>
<p>Oups. La Lune a grossi aussi. Pour corriger ça on pourrait en même temps réduire sa taille. Mais une meilleure solution serait d&#39;ajouter plus de noeuds dans notre graphe. Au lieu de faire simplement</p>
<pre class="prettyprint"><code>  soleil
   |
  terre
   |
  lune
</code></pre><p>On va faire</p>
<pre class="prettyprint"><code> systemeSolaire
   |    |
   |   soleil
   |
 orbiteTerre
   |    |
   |  terre
   |
  orbiteLune
      |
     lune
</code></pre><p>Ca permettra à la Terre de tourner autour du Soleil tout en appliquant des transformations au Soleil qui n&#39;affecteront pas la Terre. Pareil entre la Terre et la Lune. Ecrivons ces nouveaux noeuds pour <code>systemeSolaire</code>, <code>orbiteTerre</code> and <code>orbiteLune</code>.</p>
<pre class="prettyprint"><code>var noeudSystemeSolaire = new Noeud();
var noeudOrbiteTerre = new Noeud();
noeudOrbiteTerre.matriceLocale = deplacer(100, 0, 0);  // Terre à 100 unités du Soleil
var noeudOrbiteLune = new Noeud();
noeudOrbiteLune.matriceLocale = deplacer(20, 0, 0);    // Lune à 20 unités de la Terre
</code></pre><p>Ces orbites ont été changées depuis les précédentes</p>
<pre class="prettyprint"><code>var noeudTerre = new Noeud();
-noeudTerre.matriceLocale = multiplierMatrices(
-    changerEchelle(2, 2, 2),                          // Terre deux fois plus grande
-    deplacer(100, 0, 0));                             // Terre à 100 unités du Soleil
+noeudTerre.matriceLocale = changerEchelle(2, 2, 2);   // Terre deux fois plus grande

var noeudLune = new Noeud();
-noeudLune.matriceLocale = deplacer(20, 0, 0);         // Lune à 20 unités de la Terre
</code></pre><p>On définit leurs relations</p>
<pre class="prettyprint"><code>// Liens entre les objets
noeudSoleil.definirParent(noeudSystemeSolaire);
noeudOrbiteTerre.definirParent(noeudSystemeSolaire);
noeudTerre.definirParent(noeudOrbiteTerre);
noeudOrbiteLune.definirParent(noeudOrbiteTerre);
noeudLune.definirParent(noeudOrbiteLune);
</code></pre><p>Et on ne met à jour que les orbites</p>
<pre class="prettyprint"><code>// mise à jour des matrices locales
-multiplierMatrices(noeudSoleil.matriceLocale, tournerY(0.01), noeudSoleil.matriceLocale);
-multiplierMatrices(noeudTerre.matriceLocale, tournerY(0.01), noeudTerre.matriceLocale);
-multiplierMatrices(noeudLune.matriceLocale, tournerY(0.01), noeudLune.matriceLocale);
+multiplierMatrices(noeudOrbiteTerre.matriceLocale, tournerY(0.01), noeudOrbiteTerre.matriceLocale);
+multiplierMatrices(noeudOrbiteLune.matriceLocale, tournerY(0.01), noeudOrbiteLune.matriceLocale);

// mise à jour des matrices globales
-noeudSoleil.mettreAJourMatriceGlobale();
+noeudSystemeSolaire.mettreAJourMatriceGlobale();
</code></pre><p>Maintenant la Terre est plus grande, mais pas la Lune.</p>
<p><div class="webgl_example_container">
  <iframe class="webgl_example" style=" " src="/webgl/resources/editor.html?url=/webgl/lessons/..%2Fwebgl-scene-graph-solar-system-larger-earth-fixed.html"></iframe>
  <a class="webgl_center" href="/webgl/lessons/../webgl-scene-graph-solar-system-larger-earth-fixed.html" target="_blank">Cliquer ici pour ouvrir dans une nouvelle fenêtre</a>
</div>

</p>
<p>Vous aurez peut-être aussi remarqué que le soleil et la Terre ne tournent plus au même rythme.</p>
<p>Ajoutons d&#39;autres trucs. </p>
<pre class="prettyprint"><code>-noeudSoleil.matriceLocale = deplacer(0, 0, 0);  // Soleil au centre
+noeudSoleil.matriceLocale = changerEchelle(5, 5, 5);

...

+noeudLune.matriceLocale = changerEchelle(0.4, 0.4, 0.4);

...
// met à jour les matrices locales
multiplierMatrices(noeudOrbiteTerre.matriceLocale, tournerY(0.01), noeudOrbiteTerre.matriceLocale);
multiplierMatrices(noeudOrbiteLune.matriceLocale, tournerY(0.01), noeudOrbiteLune.matriceLocale);
// tourne le Soleil
multiplierMatrices(noeudSoleil.matriceLocale, tournerY(0.005), noeudSoleil.matriceLocale);
+// tourne la Terre
+multiplierMatrices(noeudTerre.matriceLocale, tournerY(0.05), noeudTerre.matriceLocale);
+// tourner la Lune
+multiplierMatrices(noeudLune.matriceLocale, tournerY(-0.01), noeudLune.matriceLocale);
</code></pre><p><div class="webgl_example_container">
  <iframe class="webgl_example" style=" " src="/webgl/resources/editor.html?url=/webgl/lessons/..%2Fwebgl-scene-graph-solar-system-adjusted.html"></iframe>
  <a class="webgl_center" href="/webgl/lessons/../webgl-scene-graph-solar-system-adjusted.html" target="_blank">Cliquer ici pour ouvrir dans une nouvelle fenêtre</a>
</div>

</p>
<p>Jusque là on a une <code>matriceLocale</code> et on la modifie à chaque rendu. Il y a un problème pourtant, puisqu&#39;à chaque rendu les opérations vont avoir quelques erreurs. Il y a un moyen de corriger ça qui s&#39;appelle <em>normalisation ortho d&#39;une matrice</em> mais même ça ne marchera pas toujours. Par exemple imaginons qu&#39;on change l&#39;échelle à zéro et qu&#39;on veuille ensuite la ramener à sa valeur initiale. Faisons ça pour une valeur <code>x</code></p>
<pre class="prettyprint"><code>x = 246;       // rendu #0, x = 246

echelle = 1;
x = x * echelle  // rendu #1, x = 246

echelle = 0.5;
x = x * echelle  // rendu #2, x = 123

echelle = 0;
x = x * echelle  // rendu #3, x = 0

echelle = 0.5;
x = x * echelle  // rendu #4, x = 0  OUPS !

echelle = 1;
x = x * echelle  // rendu #5, x = 0  OUPS !
</code></pre><p>On a perdu notre valeur. On peut corriger ça en ajoutant une autre classe qui met à jour la matrice à partir d&#39;autres valeurs. Changeons la définition de <code>Noeud</code> pour s&#39;offrir une <code>source</code>. Si elle existe on demandera à la <code>source</code> de nous donner une matrice locale.</p>
<pre class="prettyprint"><code>*var Noeud = function(source) {
  this.enfant = [];
  this.matriceLocale = matriceIdentite();
  this.matriceGlobale = matriceIdentite();
+  this.source = source;
};

Noeud.prototype.mettreAJourMatriceGlobale = function(matrice) {

+  var source = this.source;
+  if (source) {
+    source.faireMatrice(this.matriceLocale);
+  }

  ...
</code></pre><p>Maintenant créons une source. Une source classique est d&#39;avoir les valeurs de translation, rotation et échelle comme ceci :</p>
<pre class="prettyprint"><code>var Transformations = function() {
  this.translation = [0, 0, 0];
  this.rotation = [0, 0, 0];
  this.echelle = [1, 1, 1];
};

Transformations.prototype.faireMatrice = function(dst) {
  dst = dst || new Float32Array(16);
  var t = this.translation;
  var r = this.rotation;
  var s = this.echelle;

  // déduit une matrice à partir de translation, rotation et échelle
  deplacer(t[0], t[1], t[2], dst);
  multiplierMatrices(tournerX(r[0]), dst, dst);
  multiplierMatrices(tournerY(r[1]), dst, dst);
  multiplierMatrices(tournerZ(r[2]), dst, dst);
  multiplierMatrices(changerEchelle(s[0], s[1], s[2]), dst, dst);
  return dst;
};
</code></pre><p>On peut utiliser ça comme ça :</p>
<pre class="prettyprint"><code>// à l&#39;initialisation on crée un noeud avec sa source
var mesTransformations  = new Transformations();
var monNoeud = new Noeud(mesTransformations);

// au rendu
mesTransformations.rotation[2] += tempsEcoule;
</code></pre><p>Maintenant plus de souci : la matrice est recréée à chaque fois. </p>
<p>Vous vous dites peut-être, ça sert à quoi si je ne fais pas le système solaire ? Hé bien, si vous voulez animer un personnage vous aurez peut-être un graphe de scène qui ressemble à ça</p>
<p><div class="webgl_diagram_container">
  <iframe class="webgl_example " style="width: 400px; height: 400px;" src="/webgl/lessons/resources/person-diagram.html"></iframe>
</div>

</p>
<p>À vous de voir combien de liens vous ajoutez pour les doigts aux mains et aux pieds. Plus vous en mettez plus ça demande de calculs au processeur et plus il y a d&#39;informations à transmettre. Des vieux jeux comme Virtua Fighter ont 15 liens. Au début des années 2000 les jeux avaient de 30 à 70 liens. Si vous faîtes chaque lien des articulations, il y en a au moins 20 pour chaque main donc 40 pour les deux... du coup de nombreux jeux qui animent les mains n&#39;animent que le pouce et assimilent les autres doigts à un deuxième gros doigt pour économiser de la mémoire et du temps (du temps pour le calcul sur CPU, sur GPU, et dans les têtes des artistes et des programmeurs).</p>
<p>En tout cas voilà un personnage en cubes que j&#39;ai imbriqués ensemble. Il utilise une source <code>Transformations</code> pour chaque noeud mentionné au-dessus. L&#39;art de la programmation et de l&#39;animation à son sommet ! :P</p>
<p><div class="webgl_example_container">
  <iframe class="webgl_example" style=" " src="/webgl/resources/editor.html?url=/webgl/lessons/..%2Fwebgl-scene-graph-block-guy.html"></iframe>
  <a class="webgl_center" href="/webgl/lessons/../webgl-scene-graph-block-guy.html" target="_blank">Cliquer ici pour ouvrir dans une nouvelle fenêtre</a>
</div>

</p>
<p>Si vous regardez à peu près n&#39;importe quelle librairie 3D vous tomberez sur des graphes de scène comme celui-ci.</p>
<div class="webgl_bottombar">
<h3>definirParent vs ajouter / retirer</h3>
<p>Beaucoup de graphes de scène ont les méthodes <code>noeud.ajouter</code> et <code>noeud.retirer</code>
alors que j'utilise la méthode <code>noeud.definirParent</code>. C'est surtout une question de style de code mais il y a aussi une bonne raison plus objective qui est que sans definirParent le code suivant devient ambigu</p>
<pre class="prettyprint">
    unParent.ajouter(monNoeud);
    ...
    unAutreParent.ajouter(monNoeud);
</pre>
<p>Qu'est-ce que ça veut dire ? Est-ce que <code>monNoeud</code> est ajouté aux deux, <code>unParent</code> et <code>unAutreParent</code>?
Dans la plupart des graphes de scène c'est impossible. Du coup est-ce que la deuxième commande génère une erreur ?
<code>ERREUR: Un parent existe déjà</code>. Est-ce qu'il retire <code>monNoeud</code> de <code>unParent</code> avant de l'ajouter à <code>unAutreParent</code> ? Si oui alors ce n'est pas très clair dans le nom de méthode <code>ajouter</code>.
</p>
<p><code>definirParent</code> n'a pas ces problèmes</p>
<pre class="prettyprint">
    monNoeud.definirParent(unParent);
    ...
    monNoeud.definirParent(unAutreParent);
</pre>
<p>
Plus d'ambiguité, c'est 100% clair.
</p>
</div>
    </div>
    <div class="lesson-sidebar">
        <select class="language">
    <option value="/webgl/lessons/webgl-scene-graph.html" >English</a>
    <option value="/webgl/lessons/fr/webgl-scene-graph.html" selected>Français</a>
    <option value="/webgl/lessons/ja/webgl-scene-graph.html" >日本語</a>
    <option value="/webgl/lessons/ko/webgl-scene-graph.html" >한국어</a>
    <option value="/webgl/lessons/pl/webgl-scene-graph.html" >Polski</a>
    <option value="/webgl/lessons/pt-br/webgl-scene-graph.html" >Portuguese</a>
    <option value="/webgl/lessons/ru/webgl-scene-graph.html" >Русский</a>
    <option value="/webgl/lessons/zh_cn/webgl-scene-graph.html" >简体中文</a>
</select>


        <div id="toc">
          <ul>  <li>Les bases</li>
        <ul>
          <li><a href="/webgl/lessons/fr/webgl-fundamentals.html">WebGL - Les bases</a></li>
<li><a href="/webgl/lessons/fr/webgl-how-it-works.html">WebGL - Comment ça marche</a></li>
<li><a href="/webgl/lessons/fr/webgl-shaders-and-glsl.html">WebGL - Shaders et GLSL</a></li>
<li><a href="/webgl/lessons/resources/webgl-state-diagram.html">WebGL State Diagram</a></li>
        </ul>
  <li>Traitement d'image</li>
        <ul>
          <li><a href="/webgl/lessons/fr/webgl-image-processing.html">Image Processing</a></li>
<li><a href="/webgl/lessons/fr/webgl-image-processing-continued.html">Image Processing Continued</a></li>
        </ul>
  <li>2D : translation, rotation, échelle, matrices</li>
        <ul>
          <li><a href="/webgl/lessons/fr/webgl-2d-translation.html">WebGL 2D - Translation</a></li>
<li><a href="/webgl/lessons/fr/webgl-2d-rotation.html">WebGL 2D - Rotation</a></li>
<li><a href="/webgl/lessons/fr/webgl-2d-scale.html">WebGL 2D - Echelle</a></li>
<li><a href="/webgl/lessons/fr/webgl-2d-matrices.html">WebGL 2D - Matrices</a></li>
        </ul>
  <li>3D</li>
        <ul>
          <li><a href="/webgl/lessons/fr/webgl-3d-orthographic.html">WebGL 3D - Projection orthographique</a></li>
<li><a href="/webgl/lessons/fr/webgl-3d-perspective.html">WebGL 3D - La perspective</a></li>
<li><a href="/webgl/lessons/fr/webgl-3d-camera.html">WebGL 3D - Les caméras</a></li>
        </ul>
  <li>Lumières</li>
        <ul>
          <li><a href="/webgl/lessons/fr/webgl-3d-lighting-directional.html">WebGL 3D - Lumière directionnelle</a></li>
<li><a href="/webgl/lessons/fr/webgl-3d-lighting-point.html">WebGL 3D - Lumière-point</a></li>
<li><a href="/webgl/lessons/fr/webgl-3d-lighting-spot.html">Spot Lighting</a></li>
        </ul>
  <li>Structure et Organisation</li>
        <ul>
          <li><a href="/webgl/lessons/fr/webgl-less-code-more-fun.html">Less Code, More Fun</a></li>
<li><a href="/webgl/lessons/fr/webgl-drawing-multiple-things.html">Drawing Multiple Things</a></li>
<li><a href="/webgl/lessons/fr/webgl-scene-graph.html">WebGL - Graphes de scène</a></li>
        </ul>
  <li>Geometry</li>
        <ul>
          <li><a href="/webgl/lessons/fr/webgl-3d-geometry-lathe.html">Geometry - Lathe</a></li>
        </ul>
  <li>Divers</li>
        <ul>
          <li><a href="/webgl/lessons/fr/webgl-3d-textures.html">Textures</a></li>
<li><a href="/webgl/lessons/fr/webgl-data-textures.html">Data Textures</a></li>
<li><a href="/webgl/lessons/fr/webgl-2-textures.html">Using 2 or More Textures</a></li>
<li><a href="/webgl/lessons/fr/webgl-cors-permission.html">Cross Origin Images</a></li>
<li><a href="/webgl/lessons/fr/webgl-3d-perspective-correct-texturemapping.html">Perspective Correct Texture Mapping</a></li>
<li><a href="/webgl/lessons/fr/webgl-planar-projection-mapping.html">Planar and Perspective Projection Mapping</a></li>
        </ul>
  <li>Rendering To A Texture</li>
        <ul>
          <li><a href="/webgl/lessons/fr/webgl-render-to-texture.html">Render to Texture</a></li>
        </ul>
  <li>Shadows</li>
        <ul>
          <li><a href="/webgl/lessons/fr/webgl-shadows.html">Shadows</a></li>
        </ul>
  <li>Techniques</li>
        <ul>
            <li>2D</li>
        <ul>
          <li><a href="/webgl/lessons/fr/webgl-2d-drawimage.html">2D - DrawImage</a></li>
<li><a href="/webgl/lessons/fr/webgl-2d-matrix-stack.html">2D - Matrix Stack</a></li>
<li><a href="/webgl/lessons/fr/webgl-sprites.html">Sprites</a></li>
        </ul>
  <li>3D</li>
        <ul>
          <li><a href="/webgl/lessons/fr/webgl-cube-maps.html">Cubemaps</a></li>
<li><a href="/webgl/lessons/fr/webgl-environment-maps.html">Environment maps</a></li>
<li><a href="/webgl/lessons/fr/webgl-skybox.html">Skyboxes</a></li>
<li><a href="/webgl/lessons/fr/webgl-skinning.html">Skinning</a></li>
<li><a href="/webgl/lessons/fr/webgl-fog.html">Fog</a></li>
<li><a href="/webgl/lessons/fr/webgl-picking.html">Picking (clicking on stuff)</a></li>
        </ul>
  <li>Texte</li>
        <ul>
          <li><a href="/webgl/lessons/fr/webgl-text-html.html">Text - HTML</a></li>
<li><a href="/webgl/lessons/fr/webgl-text-canvas2d.html">Text - Canvas 2D</a></li>
<li><a href="/webgl/lessons/fr/webgl-text-texture.html">Text - Using a Texture</a></li>
<li><a href="/webgl/lessons/fr/webgl-text-glyphs.html">Text - Using a Glyph Texture</a></li>
        </ul>
  <li>Divers</li>
        <ul>
          <li><a href="/webgl/lessons/fr/webgl-ramp-textures.html">Ramp Textures (Toon Shading)</a></li>
        </ul>
        </ul>
  <li>Tips</li>
        <ul>
          <li><a href="/webgl/lessons/fr/webgl-smallest-programs.html">Smallest Programs</a></li>
<li><a href="/webgl/lessons/fr/webgl-drawing-without-data.html">Drawing Without Data</a></li>
<li><a href="/webgl/lessons/fr/webgl-shadertoy.html">Shadertoy</a></li>
<li><a href="/webgl/lessons/fr/webgl-pulling-vertices.html">Pulling Vertices</a></li>
        </ul>
  <li>Divers</li>
        <ul>
          <li><a href="/webgl/lessons/fr/webgl-setup-and-installation.html">Setup And Installation</a></li>
<li><a href="/webgl/lessons/fr/webgl-boilerplate.html">Boilerplate</a></li>
<li><a href="/webgl/lessons/fr/webgl-resizing-the-canvas.html">Resizing the Canvas</a></li>
<li><a href="/webgl/lessons/fr/webgl-animation.html">Animation</a></li>
<li><a href="/webgl/lessons/fr/webgl-points-lines-triangles.html">Points, Lines, and Triangles</a></li>
<li><a href="/webgl/lessons/fr/webgl-indexed-vertices.html">Indexed Vertices (gl.drawElements)</a></li>
<li><a href="/webgl/lessons/fr/webgl-instanced-drawing.html">Instanced Drawing</a></li>
<li><a href="/webgl/lessons/fr/webgl-multiple-views.html">Multiple Views, Multiple Canvases</a></li>
<li><a href="/webgl/lessons/fr/webgl-visualizing-the-camera.html">Visualizing the Camera</a></li>
<li><a href="/webgl/lessons/fr/webgl-and-alpha.html">WebGL and Alpha</a></li>
<li><a href="/webgl/lessons/fr/webgl-2d-vs-3d-library.html">2D vs 3D libraries</a></li>
<li><a href="/webgl/lessons/fr/webgl-anti-patterns.html">Anti-Patterns</a></li>
<li><a href="/webgl/lessons/fr/webgl-matrix-vs-math.html">WebGL Matrices vs Math Matrices</a></li>
<li><a href="/webgl/lessons/fr/webgl-precision-issues.html">Precision Issues</a></li>
<li><a href="/webgl/lessons/fr/webgl-tips.html#screenshot">Taking a screenshot</a></li>
<li><a href="/webgl/lessons/fr/webgl-tips.html#preservedrawingbuffer">Prevent the Canvas Being Cleared</a></li>
<li><a href="/webgl/lessons/fr/webgl-tips.html#tabindex">Get Keyboard Input From a Canvas</a></li>
<li><a href="/webgl/lessons/fr/webgl-tips.html#html-background">Use WebGL as Background in HTML</a></li>
        </ul>
  <li>Reference</li>
        <ul>
          <li><a href="/webgl/lessons/fr/webgl-attributes.html">Attributes</a></li>
<li><a href="/webgl/lessons/fr/webgl-texture-units.html">Texture Units</a></li>
<li><a href="/webgl/lessons/fr/webgl-readpixels.html">readPixels</a></li>
<li><a href="/webgl/lessons/fr/webgl-references.html">References</a></li>
        </ul></ul>
<ul>
  <li><a href="/docs/">Aide pour la doc de l'API</a></li>
  <li><a href="https://twgljs.org">TWGL, une librairie de base pour WebGL</a></li>
  <li><a href="https://github.com/gfxfundamentals/webgl-fundamentals">Github</a></li>
</ul>
        </div>
    </div>
    <div class="lesson-comments">
        <div>Une question ? <a href="https://stackoverflow.com/questions/tagged/webgl">Demander sur stackoverflow</a>.</div>
        <div>Un problème ? <a href="https://github.com/vinci-mz/webgl-fundamentals/issues">Signaler sur github</a>.</div>

        <div id="disqus_thread"></div>
        <script>
            /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
            var disqus_shortname = 'webglfundamentals'; // required: replace example with your forum shortname
            var disqus_identifier = 'WebGL - Les Graphes de Scène';
            var disqus_title = 'WebGL - Les Graphes de Scène';

            /* * * DON'T EDIT BELOW THIS LINE * * */
            (function() {
                if (window.location.hostname.indexOf("webglfundamentals.org") < 0) {
                    return;
                }
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>
  </div>
</div>
</body>
<script src="/3rdparty/jquery-1.11.2.min.js"></script>
<script src="/webgl/lessons/resources/prettify.js"></script>
<script src="/webgl/lessons/resources/lesson.js"></script>
<script>
(function() {
  if (window.location.hostname.indexOf("webglfundamentals.org") < 0) {
      return;
  }

  function addScript(src, fn) {
    const script = document.createElement('script');
    const firstScript = document.getElementsByTagName('script')[0];
    script.async = true;
    script.defer = true;
    if (fn) {
      script.addEventListener('load', fn);
    }
    script.src = src;
    firstScript.parentNode.insertBefore(script, firstScript);
  }

  addScript('//cdn.webglstats.com/stat.js');

  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-59804936-1', 'auto');
  ga('send', 'pageview');
}());
</script>


</html>



